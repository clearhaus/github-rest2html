#!/bin/sh

verbose=false
while getopts "p:v" options
do
    case $options in
        p) file_path=$OPTARG ;;
        v) verbose=true ;;
    esac
done

rst_file_path="${file_path=/github/workspace}"

if [ ! -e "$rst_file_path" ]
then
    echo >&2 "Error: ${rst_file_path} does not exist"
    exit 1
fi

failures=0
for file in $(find "$rst_file_path" -name \*.rst)
do
    echo "$file"
    if $verbose
    then
        /opt/github-rest2html/rest2html "$file"
        failures=$(($failures+$?))
    else
        /opt/github-rest2html/rest2html "$file" > /dev/null
        failures=$(($failures+$?))
    fi
done

test $failures -eq 0 || exit 1
